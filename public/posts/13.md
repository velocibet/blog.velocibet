---
title: "메신저 개발 #2: 뚫려있던 보안 구멍(IDOR) 막기와 DB 리팩터링"
date: 2026-01-30
category: devlog
tags:
  - messenger
  - devlog
summary: "채팅방 생성 시스템 및 DB 구조 리팩터링"
---

## IDOR 보안 취약점 해결
가장 먼저 진행한 것은 보안 강화였습니다. 기존 로직은 클라이언트가 보내주는 `userId`를 그대로 신뢰하여 쿼리를 실행하는 구조였으나, 이는 패킷 변조를 통해 타인의 권한을 도용할 수 있는 **IDOR(Insecure Direct Object Reference)** 취약점에 노출되어 있었습니다.

**Postman으로 직접 post 요청을 날려본 결과 본인이 아님에도 불구하고 실제로 비밀번호 변경 및 계정 삭제가 가능했습니다.**

따라서 모든 민감한 요청에서 `userId`를 바디(Body)가 아닌 **서버 세션(req.session.user)** 에서 직접 추출하도록 변경했습니다. 이제 공격자가 ID값을 조작하더라도 본인의 데이터에만 접근할 수 있도록 원천 봉쇄했습니다.

## 채팅방 구조 변경 및 DB 구조 리팩터링
기존의 단순했던 1:1 채팅방 구조를 실제 서비스가 가능한 수준으로 고도화하고, 데이터 간의 관계를 더 명확하게 정의하는 리팩터링 작업을 진행했습니다.

### 채팅방 생성 시스템의 변화
단순히 유저 ID만 넘기면 방이 생성되던 방식에서, **다대다(M:N) 관계를 고려한 구조**로 변경했습니다. 

![채팅방 생성](images/post13-01.png)

유저와 채팅방 사이의 관계를 더 세밀하게 관리하기 위해 채팅방 생성에 필요한 테이블들을 만들었습니다. 1:1 채팅방의 경우 이미 방이 존재하는지 먼저 확인하고, 없을 때만 생성하는 로직을 추가하여 중복 방 생성을 방지했습니다. (아래는 sql 쿼리의 일부)

```sql
CREATE TABLE public.room (
    id bigserial PRIMARY KEY,
    type room_type NOT NULL,
    title text,
    owner_user_id bigint,
    dm_hash text,
    created_at timestamp with time zone NOT NULL DEFAULT now()
);

CREATE TABLE public.room_user (
    id bigserial PRIMARY KEY,
    room_id bigint NOT NULL,
    user_id bigint NOT NULL,
    role room_user_role NOT NULL DEFAULT 'member',
    joined_at timestamp with time zone NOT NULL DEFAULT now(),
    left_at timestamp with time zone,
    CONSTRAINT fk_room_user_room FOREIGN KEY (room_id) 
        REFERENCES public.room(id) ON DELETE CASCADE
);
```

## 앞으로 해야할 일
- 프론트엔드 유저 프로필 팝업 UI 완성
- 단체 채팅방에서 온오프라인 표시 기능 완성